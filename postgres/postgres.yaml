version: "3.8"

services:
  postgres:
    # 1) imagem já com pgvector instalado
    image: pgvector/pgvector:pg15
    command:
      - postgres
      - --shared_preload_libraries=pgvector   # 2) carrega extensão
      - --max_connections=300
      - --wal_level=minimal
      - --max_wal_senders=0
    environment:
      - POSTGRES_PASSWORD=${SENHA_POSTGRES}
      - POSTGRES_INITDB_ARGS="--auth-host=scram-sha-256"
    networks:
      - interna
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: "2"
          memory: 2048M
    configs:
      # 3) init cria EXTENSION vector
      - source: entrypoint_postgres
        target: /docker-entrypoint-initdb.d/init-db.sh
        mode: 0755

  pgadmin4:
    image: dpage/pgadmin4
    restart: always
    deploy:
      labels:
        traefik.enable: "true"
        traefik.http.routers.pga.entrypoints: "websecure"
        traefik.http.routers.pga.tls.certresolver: "letsencryptresolver"
        traefik.http.services.pga.loadbalancer.server.port: 80
        traefik.http.services.pga.loadbalancer.passHostHeader: "true"
        traefik.http.routers.pga.rule: >-
          Host(`${SUBDOMAIN:-pgadmin}.${DOMAIN:-seudominio.com.br}`,
               `www.${SUBDOMAIN:-pgadmin}.${DOMAIN:-seudominio.com.br}`)
        traefik.http.routers.pga.service: "pga"
    environment:
      PGADMIN_DEFAULT_EMAIL: '${SEU_EMAIL}'
      PGADMIN_DEFAULT_PASSWORD: '${SUA_SENHA}'
    networks:
      - interna
      - externa

volumes:
  postgres_data:
    external: true

configs:
  entrypoint_postgres:
    external: true

networks:
  interna:
    external: true
  externa:
    external: true